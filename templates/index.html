<!DOCTYPE html>
<html>
  <head>
    <title>Peta Madura</title>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .legend {
        line-height: 18px;
        color: #555;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
      }

      .legend {
        background: white;
        padding: 10px;
        line-height: 1.6;
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        font-size: 13px;
      }

      .legend h4 {
        margin: 0 0 5px 0;
        padding: 0;
        font-size: 14px;
        font-weight: bold;
      }

      .legend .item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .legend .swatch {
        width: 18px;
        height: 12px;
        border: 1px solid #444;
      }

      /* === HEADER MENU === */
      .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #1a73e8;
        padding: 10px 20px;
        color: white;
        font-size: 15px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      .navbar .brand {
        font-size: 18px;
        font-weight: bold;
      }

      .navbar .menu {
        list-style: none;
        display: flex;
        gap: 20px;
        margin: 0;
        padding: 0;
      }

      .navbar .menu li a {
        color: white;
        text-decoration: none;
        font-weight: 500;
      }

      .navbar .menu li a:hover {
        text-decoration: underline;
      }

      /* agar peta tidak tertutup header */

      #map {
        height: calc(100% - 50px);
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="brand">Peta Madura</div>
        <ul class="menu">
          <li><a href="/">Beranda</a></li>
          <li><a href="/crop">Rekomendasi Tanaman</a></li>
          <li><a href="#">Tentang</a></li>
        </ul>
      </nav>
    </header>

    <div id="map">
      <div id="chartBox" style="
        position: absolute;
        top: 80px;
        right: 20px;
        width: 450px;
        background: white;
        border-radius: 10px;
        padding: 15px 15px 10px 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        display: none;
        z-index: 9999;">

        <!-- HEADER + TOMBOL CLOSE -->
        <div style="
          display:flex;
          justify-content: space-between;
          align-items:center;
          margin-bottom: 10px;">
          <h4 id="chartTitle" style="margin:0;"></h4>

          <button onclick="tutupChart()" style="
            border: none;
            background: transparent;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;">✖</button>
        </div>

        <canvas id="forecastChart"></canvas>
    </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      function tutupChart() {
        document.getElementById("chartBox").style.display = "none";

        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }
      }

      let chartInstance = null;

      function tampilkanGrafik(kabupaten, data) {
        document.getElementById("chartBox").style.display = "block";
        document.getElementById("chartTitle").innerText =
          `Forecasting Cuaca ${kabupaten}`;

        const labels = [
          ...data.last_days.dates,
          ...data.forecast.dates
        ];

        const lastData = data.last_days.values.map(v => v[0]);
        const forecastData = data.forecast.values.map(v => v[0]);

        const totalData = [...lastData, ...forecastData];

        const ctx = document.getElementById("forecastChart").getContext("2d");

        if (chartInstance) {
          chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Data 3 Hari Terakhir",
                data: lastData,
                borderWidth: 2,
                tension: 0.4,
                fill: false
              },
              {
                label: "Forecast 5 Hari Kedepan",
                data: Array(lastData.length).fill(null).concat(forecastData),
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: false }
            }
          }
        });
      }
    </script>


    <script>
      // Warna per kabupaten berdasarkan nm_dati2
      const warnaKab = {
        Bangkalan: "#e41a1c",
        Sampang: "#377eb8",
        Pamekasan: "#4daf4a",
        Sumenep: "#984ea3",
      };

      var map = L.map("map").setView([-7.0, 113.9], 10);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
      }).addTo(map);

      fetch("{{ url_for('static', filename='Madura.geojson') }}")
        .then((res) => res.json())
        .then((data) => {
          L.geoJSON(data, {
            style: function (feature) {
              const nama = feature.properties.nm_dati2; // ← ini penting
              console.log(nama);
              return {
                color: "#000",
                weight: 0.2,
                fillColor: warnaKab[nama] || "#cccccc",
                fillOpacity: 0.6,
              };
            },
            onEachFeature: function (feature, layer) {
              const nama = feature.properties.nm_dati2;

              layer.bindPopup(nama + " Kabupaten");

              layer.on("click", function () {
                fetch(`/forecast/${nama}`)
                  .then(res => res.json())
                  .then(data => tampilkanGrafik(nama, data));
              });
            },
          }).addTo(map);
        });

      // === LEGEND ===
      var legend = L.control({ position: "bottomright" });

      legend.onAdd = function (map) {
        var div = L.DomUtil.create("div", "legend");

        div.innerHTML += "<h4>Kabupaten Madura</h4>";

        const items = [
          { label: "Bangkalan", color: "#e41a1c" },
          { label: "Sampang", color: "#377eb8" },
          { label: "Pamekasan", color: "#4daf4a" },
          { label: "Sumenep", color: "#984ea3" },
        ];

        items.forEach((item) => {
          div.innerHTML += `
            <div class="item">
                <span class="swatch" style="background:${item.color};"></span>
                ${item.label}
            </div>
        `;
        });

        return div;
      };

      legend.addTo(map);
    </script>
  </body>
</html>
